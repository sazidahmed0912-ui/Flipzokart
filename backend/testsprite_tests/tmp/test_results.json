[
  {
    "projectId": "f0cc9759-3b53-4271-9e44-2b2e4fa041e7",
    "testId": "64dbc54f-5fce-4b9d-a000-7b2a4b5122c6",
    "userId": "34d8e438-1081-7025-6dfe-092cb8b46084",
    "title": "TC003-test email service integration with zoho oauth2 smtp",
    "description": "Verify that the email service sends emails using Zoho OAuth2 SMTP via Nodemailer without authentication errors and handles failures gracefully.",
    "code": "import os\nimport requests\nimport smtplib\nimport socket\nimport time\nfrom email.message import EmailMessage\n\nBASE_URL = \"http://localhost:5000\"\nSMTP_HOST = \"smtp.zoho.in\"\nSMTP_PORT = 465\nSMTP_TIMEOUT = 10\n\n# Retrieve necessary environment variables for Zoho OAuth2 SMTP\nZOHO_SMTP_EMAIL = os.getenv(\"ZOHO_SMTP_EMAIL\")\nZOHO_SMTP_OAUTH2_ACCESS_TOKEN = os.getenv(\"ZOHO_SMTP_OAUTH2_ACCESS_TOKEN\")\n\ndef test_email_service_integration_with_zoho_oauth2_smtp():\n    assert ZOHO_SMTP_EMAIL, \"Environment variable ZOHO_SMTP_EMAIL is not set\"\n    assert ZOHO_SMTP_OAUTH2_ACCESS_TOKEN, \"Environment variable ZOHO_SMTP_OAUTH2_ACCESS_TOKEN is not set\"\n\n    # Verify direct socket connection to smtp.zoho.in on port 465\n    try:\n        with socket.create_connection((SMTP_HOST, SMTP_PORT), timeout=SMTP_TIMEOUT):\n            pass\n    except socket.timeout:\n        assert False, f\"Timed out connecting to {SMTP_HOST}:{SMTP_PORT}\"\n    except Exception as e:\n        assert False, f\"Failed to connect to {SMTP_HOST}:{SMTP_PORT} due to: {e}\"\n\n    # Compose email payload for API request\n    test_email_payload = {\n        \"to\": ZOHO_SMTP_EMAIL,\n        \"subject\": \"Test Email Service Integration\",\n        \"text\": \"This is a test email to verify Zoho OAuth2 SMTP integration.\"\n    }\n\n    headers = {\n        \"Content-Type\": \"application/json\"\n    }\n\n    # Send email via the application's email sending endpoint\n    # Assume POST /email/send is the endpoint to send emails\n    # We do not have explicit API doc for the endpoint, assuming common pattern\n    try:\n        response = requests.post(\n            f\"{BASE_URL}/email/send\",\n            json=test_email_payload,\n            headers=headers,\n            timeout=30\n        )\n    except requests.exceptions.RequestException as e:\n        assert False, f\"Email service request failed with exception: {e}\"\n\n    # Validate response status code for success\n    assert response.status_code in (200, 202), (\n        f\"Expected status 200 or 202, got {response.status_code}. Response: {response.text}\"\n    )\n\n    # Validate response body presence and content typical for success or known error\n    try:\n        resp_json = response.json()\n    except ValueError:\n        assert False, \"Response is not valid JSON\"\n\n    # Check for errors related to SMTP authentication or timeout in response\n    error = resp_json.get(\"error\") or resp_json.get(\"message\")\n    if error:\n        # If error mentions ETIMEDOUT or auth issues, fail test\n        err_lower = str(error).lower()\n        assert \"etimedout\" not in err_lower, f\"ETIMEDOUT error encountered: {error}\"\n        assert \"authentication\" not in err_lower and \"auth\" not in err_lower, f\"Authentication error encountered: {error}\"\n\n    # If present, check a success indicator in response\n    success_indicators = [\"success\", \"sent\", \"queued\"]\n    response_text = str(resp_json).lower()\n    assert any(indicator in response_text for indicator in success_indicators), (\n        f\"Response does not indicate success: {resp_json}\"\n    )\n\n\ntest_email_service_integration_with_zoho_oauth2_smtp()",
    "testStatus": "FAILED",
    "testError": "Traceback (most recent call last):\n  File \"/var/task/handler.py\", line 258, in run_with_retry\n    exec(code, exec_env)\n  File \"<string>\", line 81, in <module>\n  File \"<string>\", line 18, in test_email_service_integration_with_zoho_oauth2_smtp\nAssertionError: Environment variable ZOHO_SMTP_EMAIL is not set\n",
    "testType": "BACKEND",
    "createFrom": "mcp",
    "created": "2026-01-29T08:56:40.511Z",
    "modified": "2026-01-29T08:56:53.722Z"
  }
]
