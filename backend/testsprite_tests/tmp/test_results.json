[
  {
    "projectId": "bfc8efdd-02c3-44f6-a696-e03fee6d25e8",
    "testId": "934b97d6-b55f-4418-a91d-5c201194b4c1",
    "userId": "34d8e438-1081-7025-6dfe-092cb8b46084",
    "title": "TC001-verify razorpay payment signature",
    "description": "Test the /api/order/verify-payment POST endpoint to ensure it correctly validates the Razorpay payment signature. Verify that valid signatures return a 200 status with a success message, invalid signatures return a 400 status with an error message, and server errors return a 500 status.",
    "code": "import os\nimport requests\nimport hashlib\nimport hmac\nimport json\n\nBASE_URL = \"http://localhost:5000\"\nVERIFY_PAYMENT_ENDPOINT = \"/api/order/verify-payment\"\nTIMEOUT = 30\n\ndef test_verify_razorpay_payment_signature():\n    secret = os.environ.get(\"RAZORPAY_KEY_SECRET\")\n    assert secret, \"Environment variable RAZORPAY_KEY_SECRET must be set\"\n\n    headers = {\n        \"Content-Type\": \"application/json\"\n    }\n\n    # Sample data for the payment verification request\n    razorpay_order_id = \"order_9A33XWu170gUtm\"\n    razorpay_payment_id = \"pay_29QQoUBi66xm2f\"\n    \n    # Generate a valid signature\n    msg = f\"{razorpay_order_id}|{razorpay_payment_id}\"\n    valid_signature = hmac.new(\n        secret.encode(), msg.encode(), hashlib.sha256\n    ).hexdigest()\n\n    # --- Test Case 1: Valid signature ---\n    payload_valid = {\n        \"razorpay_order_id\": razorpay_order_id,\n        \"razorpay_payment_id\": razorpay_payment_id,\n        \"razorpay_signature\": valid_signature\n    }\n    try:\n        response = requests.post(\n            BASE_URL + VERIFY_PAYMENT_ENDPOINT,\n            headers=headers,\n            json=payload_valid,\n            timeout=TIMEOUT\n        )\n    except requests.RequestException as e:\n        assert False, f\"Request failed: {e}\"\n    assert response.status_code == 200, f\"Expected 200 but got {response.status_code}\"\n    try:\n        resp_json = response.json()\n    except json.JSONDecodeError:\n        resp_json = {}\n    assert (\n        (\"success\" in resp_json.get(\"message\", \"\").lower()) or (\"verified\" in resp_json.get(\"message\", \"\").lower())\n    ), f\"Unexpected response message: {resp_json.get('message')}\"\n\n    # --- Test Case 2: Invalid signature ---\n    payload_invalid = {\n        \"razorpay_order_id\": razorpay_order_id,\n        \"razorpay_payment_id\": razorpay_payment_id,\n        \"razorpay_signature\": \"invalidsignature1234567890\"\n    }\n    try:\n        response = requests.post(\n            BASE_URL + VERIFY_PAYMENT_ENDPOINT,\n            headers=headers,\n            json=payload_invalid,\n            timeout=TIMEOUT\n        )\n    except requests.RequestException as e:\n        assert False, f\"Request failed: {e}\"\n    assert response.status_code == 400, f\"Expected 400 but got {response.status_code}\"\n    try:\n        resp_json = response.json()\n    except json.JSONDecodeError:\n        resp_json = {}\n    assert (\n        (\"invalid\" in resp_json.get(\"message\", \"\").lower()) or (\"error\" in resp_json.get(\"message\", \"\").lower())\n    ), f\"Unexpected response message: {resp_json.get('message')}\"\n\n    # --- Test Case 3: Simulate server error ---\n    # There is no explicit way in the spec to induce 500 error,\n    # so we try sending incomplete data or malformed JSON to trigger server error.\n    # Here, send a completely empty body to test server error handling.\n    try:\n        response = requests.post(\n            BASE_URL + VERIFY_PAYMENT_ENDPOINT,\n            headers=headers,\n            data=\"\",\n            timeout=TIMEOUT\n        )\n    except requests.RequestException as e:\n        assert False, f\"Request failed: {e}\"\n\n    # The server may respond with 400 or 500 based on implementation.\n    # We assert if status is 500 or handle accordingly.\n    if response.status_code != 500:\n        # If not 500, try sending malformed JSON to provoke 500\n        try:\n            response = requests.post(\n                BASE_URL + VERIFY_PAYMENT_ENDPOINT,\n                headers=headers,\n                data=\"{bad json\",\n                timeout=TIMEOUT\n            )\n        except requests.RequestException as e:\n            assert False, f\"Request failed: {e}\"\n\n    assert (\n        response.status_code == 500\n    ), f\"Expected 500 but got {response.status_code}\"\n\ntest_verify_razorpay_payment_signature()",
    "testStatus": "FAILED",
    "testError": "Traceback (most recent call last):\n  File \"/var/task/handler.py\", line 258, in run_with_retry\n    exec(code, exec_env)\n  File \"<string>\", line 109, in <module>\n  File \"<string>\", line 13, in test_verify_razorpay_payment_signature\nAssertionError: Environment variable RAZORPAY_KEY_SECRET must be set\n",
    "testType": "BACKEND",
    "createFrom": "mcp",
    "created": "2026-01-26T16:18:09.046Z",
    "modified": "2026-01-26T16:18:25.145Z"
  }
]
