[
  {
    "projectId": "e52fa6f7-ea54-4d89-9433-b8fc0e08a2d9",
    "testId": "ec82d8a7-c06c-4cb6-b29d-f5879a265ef3",
    "userId": "34d8e438-1081-7025-6dfe-092cb8b46084",
    "title": "TC001-verify razorpay payment signature",
    "description": "Test the /api/order/verify-payment POST endpoint to ensure it correctly validates the Razorpay payment signature. Verify that valid signatures return a 200 status with a success message, invalid signatures return a 400 status with an error message, and server errors return a 500 status.",
    "code": "import requests\nimport hashlib\nimport hmac\nimport json\n\nBASE_URL = \"http://localhost:5000\"\nTIMEOUT = 30\nRAZORPAY_KEY_SECRET = \"test_secret\"\nHEADERS = {\"Content-Type\": \"application/json\"}\n\ndef generate_signature(order_id, payment_id, secret):\n    msg = f\"{order_id}|{payment_id}\"\n    signature = hmac.new(\n        key=secret.encode('utf-8'),\n        msg=msg.encode('utf-8'),\n        digestmod=hashlib.sha256\n    ).hexdigest()\n    return signature\n\ndef test_verify_razorpay_payment_signature():\n    razorpay_order_id = \"order_test_123\"\n    razorpay_payment_id = \"pay_test_456\"\n    valid_signature = generate_signature(razorpay_order_id, razorpay_payment_id, RAZORPAY_KEY_SECRET)\n\n    # Test valid signature\n    payload_valid = {\n        \"razorpay_order_id\": razorpay_order_id,\n        \"razorpay_payment_id\": razorpay_payment_id,\n        \"razorpay_signature\": valid_signature\n    }\n    try:\n        response_valid = requests.post(f\"{BASE_URL}/api/order/verify-payment\", headers=HEADERS, json=payload_valid, timeout=TIMEOUT)\n    except requests.RequestException as e:\n        assert False, f\"Request failed for valid signature test: {e}\"\n    assert response_valid.status_code == 200, f\"Expected 200 for valid signature but got {response_valid.status_code}\"\n    try:\n        data_valid = response_valid.json()\n    except json.JSONDecodeError:\n        assert False, \"Response is not valid JSON for valid signature\"\n    assert \"success\" in data_valid.get(\"message\", \"\").lower(), f\"Success message not found in valid signature response: {data_valid}\"\n\n    # Test invalid signature\n    payload_invalid = {\n        \"razorpay_order_id\": razorpay_order_id,\n        \"razorpay_payment_id\": razorpay_payment_id,\n        \"razorpay_signature\": \"invalid_signature\"\n    }\n    try:\n        response_invalid = requests.post(f\"{BASE_URL}/api/order/verify-payment\", headers=HEADERS, json=payload_invalid, timeout=TIMEOUT)\n    except requests.RequestException as e:\n        assert False, f\"Request failed for invalid signature test: {e}\"\n    assert response_invalid.status_code == 400, f\"Expected 400 for invalid signature but got {response_invalid.status_code}\"\n    try:\n        data_invalid = response_invalid.json()\n    except json.JSONDecodeError:\n        assert False, \"Response is not valid JSON for invalid signature\"\n    err_msg = data_invalid.get(\"error\") or data_invalid.get(\"message\") or \"\"\n    assert err_msg, f\"No error message in invalid signature response: {data_invalid}\"\n\n    # Test server error simulation (e.g., sending malformed payload)\n    payload_error = {\n        \"razorpay_order_id\": None,\n        \"razorpay_payment_id\": None,\n        \"razorpay_signature\": None\n    }\n    try:\n        response_error = requests.post(f\"{BASE_URL}/api/order/verify-payment\", headers=HEADERS, json=payload_error, timeout=TIMEOUT)\n    except requests.RequestException as e:\n        assert False, f\"Request failed for server error simulation test: {e}\"\n    # Allow either 500 or error-like status due to server error\n    assert response_error.status_code == 500, f\"Expected 500 for server error simulation but got {response_error.status_code}\"\n\ntest_verify_razorpay_payment_signature()",
    "testStatus": "FAILED",
    "testError": "Traceback (most recent call last):\n  File \"/var/task/handler.py\", line 258, in run_with_retry\n    exec(code, exec_env)\n  File \"<string>\", line 73, in <module>\n  File \"<string>\", line 35, in test_verify_razorpay_payment_signature\nAssertionError: Expected 200 for valid signature but got 401\n",
    "testType": "BACKEND",
    "createFrom": "mcp",
    "created": "2026-01-26T16:31:31.127Z",
    "modified": "2026-01-26T16:31:48.130Z"
  }
]
