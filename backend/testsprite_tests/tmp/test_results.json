[
  {
    "projectId": "061bfb80-238f-45fe-b180-5cb5655eb786",
    "testId": "ee577488-f198-4655-b476-6f8bf38ddbbc",
    "userId": "34d8e438-1081-7025-6dfe-092cb8b46084",
    "title": "TC001-test otp generation and email sending",
    "description": "Verify that the API endpoint for OTP generation correctly generates an OTP, sends it via email using the Zoho OAuth2 SMTP service through Nodemailer, and responds with the appropriate success or error status.",
    "code": "import requests\nimport time\n\nBASE_URL = \"http://localhost:5000\"\nTIMEOUT = 30\n\ndef test_otp_generation_and_email_sending():\n    endpoint = f\"{BASE_URL}/auth/generate-otp\"\n    test_email = \"testuser@example.com\"\n    headers = {\n        \"Content-Type\": \"application/json\",\n        \"Accept\": \"application/json\"\n    }\n    payload = {\n        \"email\": test_email\n    }\n\n    start_time = time.time()\n    try:\n        response = requests.post(endpoint, json=payload, headers=headers, timeout=TIMEOUT)\n    except requests.RequestException as e:\n        assert False, f\"Request to generate OTP failed: {e}\"\n    elapsed = time.time() - start_time\n\n    # Verify that response status code is 200 (success)\n    assert response.status_code == 200, f\"Expected status code 200 but got {response.status_code}\"\n\n    # Verify response body contains success indication (assume JSON with success key)\n    try:\n        json_resp = response.json()\n    except ValueError:\n        assert False, \"Response is not a valid JSON\"\n\n    # Assume API returns keys: success (bool), message (str), otpGenerated (bool or otp code masked)\n    assert \"success\" in json_resp, \"Response JSON missing 'success' key\"\n    assert json_resp[\"success\"] is True, f\"OTP generation not successful: {json_resp.get('message','')}\"\n    assert \"message\" in json_resp, \"Response JSON missing 'message' key\"\n    # Optionally check message if needed (e.g. OTP sent)\n\n    # Verify that the API responds quickly (within 5 seconds to indicate non-blocking email sending)\n    assert elapsed <= 5, f\"API response too slow, took {elapsed:.2f} seconds, expected <= 5 seconds\"\n\n    # Verify /health endpoint to check service health (if possible)\n    health_endpoint = f\"{BASE_URL}/health\"\n    try:\n        health_resp = requests.get(health_endpoint, timeout=TIMEOUT)\n        assert health_resp.status_code == 200, f\"/health endpoint returned status {health_resp.status_code}\"\n        try:\n            health_json = health_resp.json()\n            # If health JSON structure known, check keys: status='ok' or similar\n            assert health_json.get(\"status\",\"\").lower() == \"ok\", \"/health status not ok\"\n        except ValueError:\n            # If no JSON response, accept plain 200 status as healthy\n            pass\n    except requests.RequestException:\n        # If /health not reachable, this is not blocking test case but warn\n        pass\n\ntest_otp_generation_and_email_sending()\n",
    "testStatus": "FAILED",
    "testError": "Traceback (most recent call last):\n  File \"/var/task/handler.py\", line 258, in run_with_retry\n    exec(code, exec_env)\n  File \"<string>\", line 59, in <module>\n  File \"<string>\", line 26, in test_otp_generation_and_email_sending\nAssertionError: Expected status code 200 but got 404\n",
    "testType": "BACKEND",
    "createFrom": "mcp",
    "created": "2026-01-29T09:04:36.625Z",
    "modified": "2026-01-29T09:05:05.994Z"
  },
  {
    "projectId": "061bfb80-238f-45fe-b180-5cb5655eb786",
    "testId": "fcd4f521-6c0e-4a7c-961e-e6cfbdad1e67",
    "userId": "34d8e438-1081-7025-6dfe-092cb8b46084",
    "title": "TC002-test otp verification and user authentication",
    "description": "Verify that the API endpoint for OTP verification correctly validates the submitted OTP, authenticates the user, and returns the appropriate session or token along with correct status and error messages.",
    "code": "import requests\n\nBASE_URL = \"http://localhost:5000\"\nHEADERS = {\"Content-Type\": \"application/json\"}\nTIMEOUT = 30\n\ndef test_otp_verification_and_user_authentication():\n    email = \"testuser@example.com\"\n    otp_request_payload = {\"email\": email}\n\n    # Step 1: Request OTP generation\n    otp_gen_resp = requests.post(\n        f\"{BASE_URL}/auth/request-otp\", json=otp_request_payload, headers=HEADERS, timeout=TIMEOUT\n    )\n    assert otp_gen_resp.status_code == 200, f\"OTP request failed: {otp_gen_resp.text}\"\n    otp_gen_data = otp_gen_resp.json()\n    assert \"message\" in otp_gen_data and \"OTP sent\" in otp_gen_data[\"message\"]\n\n    # NOTE: Since this is a test environment, assume OTP can be fetched through an API or a test hook\n    # We'll try to get the OTP via a test endpoint /auth/get-latest-otp for the email\n    # If such an endpoint is not available, this test would require manual OTP input or mocking.\n    try:\n        otp_retrieve_resp = requests.get(\n            f\"{BASE_URL}/auth/get-latest-otp\", params={\"email\": email}, headers=HEADERS, timeout=TIMEOUT\n        )\n        assert otp_retrieve_resp.status_code == 200, f\"Failed to get OTP: {otp_retrieve_resp.text}\"\n        otp_retrieve_data = otp_retrieve_resp.json()\n        assert \"otp\" in otp_retrieve_data, \"OTP not found in response\"\n        otp = otp_retrieve_data[\"otp\"]\n    except Exception:\n        # If OTP retrieval endpoint not available, fallback to failure as OTP unknown\n        raise AssertionError(\"Unable to retrieve OTP for verification test\")\n\n    # Step 2: Verify OTP and authenticate\n    otp_verify_payload = {\"email\": email, \"otp\": otp}\n    otp_verify_resp = requests.post(\n        f\"{BASE_URL}/auth/verify-otp\", json=otp_verify_payload, headers=HEADERS, timeout=TIMEOUT\n    )\n    assert otp_verify_resp.status_code == 200, f\"OTP verification failed: {otp_verify_resp.text}\"\n    otp_verify_data = otp_verify_resp.json()\n\n    # Validate expected fields in response\n    assert \"token\" in otp_verify_data or \"session\" in otp_verify_data, \"No token or session in response\"\n    assert \"message\" in otp_verify_data, \"No message in response\"\n    assert otp_verify_data.get(\"message\").lower().find(\"success\") != -1 or otp_verify_data.get(\"message\").lower().find(\"authenticated\") != -1\n\n    # Step 3: Negative test - invalid OTP should return error\n    invalid_otp_payload = {\"email\": email, \"otp\": \"000000\"}\n    invalid_otp_resp = requests.post(\n        f\"{BASE_URL}/auth/verify-otp\", json=invalid_otp_payload, headers=HEADERS, timeout=TIMEOUT\n    )\n    assert invalid_otp_resp.status_code in (400, 401), f\"Invalid OTP accepted: {invalid_otp_resp.text}\"\n    invalid_otp_data = invalid_otp_resp.json()\n    assert \"error\" in invalid_otp_data or \"message\" in invalid_otp_data\n    assert \"invalid\" in invalid_otp_data.get(\"error\", \"\").lower() or \"invalid\" in invalid_otp_data.get(\"message\", \"\").lower()\n\ntest_otp_verification_and_user_authentication()",
    "testStatus": "FAILED",
    "testError": "Traceback (most recent call last):\n  File \"/var/task/handler.py\", line 258, in run_with_retry\n    exec(code, exec_env)\n  File \"<string>\", line 57, in <module>\n  File \"<string>\", line 15, in test_otp_verification_and_user_authentication\nAssertionError: OTP request failed: <!DOCTYPE html>\n<html lang=\"en\">\n<head>\n<meta charset=\"utf-8\">\n<title>Error</title>\n</head>\n<body>\n<pre>Cannot POST /auth/request-otp</pre>\n</body>\n</html>\n\n",
    "testType": "BACKEND",
    "createFrom": "mcp",
    "created": "2026-01-29T09:04:36.632Z",
    "modified": "2026-01-29T09:04:56.372Z"
  },
  {
    "projectId": "061bfb80-238f-45fe-b180-5cb5655eb786",
    "testId": "78e99ad7-56a0-48a0-b537-a652c2e1242f",
    "userId": "34d8e438-1081-7025-6dfe-092cb8b46084",
    "title": "TC003-test email service integration with zoho oauth2 smtp",
    "description": "Verify that the email service sends emails using Zoho OAuth2 SMTP via Nodemailer without authentication errors and handles failures gracefully.",
    "code": "import requests\nimport json\n\nBASE_URL = \"http://localhost:5000\"\nTIMEOUT = 30\nHEADERS = {'Content-Type': 'application/json'}\n\n\ndef test_email_service_integration_with_zoho_oauth2_smtp():\n    send_email_endpoint = f\"{BASE_URL}/email/send\"\n    # Construct a valid email payload to trigger Zoho OAuth2 SMTP via Nodemailer\n    email_payload = {\n        \"to\": \"testrecipient@example.com\",\n        \"subject\": \"Integration Test Email\",\n        \"text\": \"This is a test email sent using Zoho OAuth2 SMTP via Nodemailer.\",\n        \"html\": \"<p>This is a test email sent using Zoho OAuth2 SMTP via Nodemailer.</p>\"\n    }\n\n    try:\n        response = requests.post(send_email_endpoint, headers=HEADERS, json=email_payload, timeout=TIMEOUT)\n    except requests.RequestException as e:\n        assert False, f\"Request to send email failed: {e}\"\n\n    # The expected success status code is assumed 200; adjust if API differs\n    assert response.status_code == 200, f\"Expected status code 200, got {response.status_code}\"\n\n    try:\n        resp_json = response.json()\n    except json.JSONDecodeError:\n        assert False, \"Response is not in JSON format\"\n\n    # Validate response contains success indication and no auth error\n    # Assuming API returns {\"success\": true, \"message\": \"...\"} or error info\n    assert \"success\" in resp_json, \"Response JSON missing 'success' key\"\n    assert resp_json[\"success\"] is True, f\"Email sending was not successful: {resp_json}\"\n\n    # Validate no authentication error messages in response\n    # Commonly error messages might be inside a \"message\" or \"error\" field\n    error_fields = [\"message\", \"error\", \"errors\"]\n    auth_error_keywords = [\"authentication failed\", \"auth error\", \"invalid credentials\", \"oauth2 error\", \"authentication error\"]\n\n    for field in error_fields:\n        if field in resp_json:\n            msg = str(resp_json[field]).lower()\n            for keyword in auth_error_keywords:\n                assert keyword not in msg, f\"Authentication error detected in response message: '{resp_json[field]}'\"\n\n    # Testing failure handling: send invalid payload to provoke failure\n    invalid_payload = {\n        \"to\": \"invalid-email-address\",\n        \"subject\": \"Invalid Test Email\",\n        \"text\": \"This email should fail due to invalid recipient.\"\n    }\n\n    try:\n        fail_response = requests.post(send_email_endpoint, headers=HEADERS, json=invalid_payload, timeout=TIMEOUT)\n    except requests.RequestException as e:\n        assert False, f\"Request to send email with invalid payload failed: {e}\"\n\n    # Expect a 4xx client error for invalid input\n    assert 400 <= fail_response.status_code < 500, f\"Expected 4xx client error for invalid payload, got {fail_response.status_code}\"\n\n    try:\n        fail_resp_json = fail_response.json()\n    except json.JSONDecodeError:\n        assert False, \"Failure response is not in JSON format\"\n\n    # Validate error is handled gracefully with error message\n    assert \"success\" in fail_resp_json, \"Failure response JSON missing 'success' key\"\n    assert fail_resp_json[\"success\"] is False or fail_resp_json.get(\"error\") is not None, (\n        \"Failure response does not properly indicate error\"\n    )\n\n\ntest_email_service_integration_with_zoho_oauth2_smtp()",
    "testStatus": "FAILED",
    "testError": "Traceback (most recent call last):\n  File \"/var/task/handler.py\", line 258, in run_with_retry\n    exec(code, exec_env)\n  File \"<string>\", line 75, in <module>\n  File \"<string>\", line 25, in test_email_service_integration_with_zoho_oauth2_smtp\nAssertionError: Expected status code 200, got 404\n",
    "testType": "BACKEND",
    "createFrom": "mcp",
    "created": "2026-01-29T09:04:36.637Z",
    "modified": "2026-01-29T09:04:53.765Z"
  }
]
